upgrade_frankenphp_binary() {
    local target_bin_dir
    local frankenphp_path

    # First, try to find the path of the existing frankenphp command.
    frankenphp_path=$(command -v frankenphp)

    if [ -n "$frankenphp_path" ]; then
        # If found, use its directory as the installation target.
        target_bin_dir=$(dirname "$frankenphp_path")
        echo "   - Detected existing FrankenPHP in '$target_bin_dir'. Using this as the installation target."
    else
        # If not found, use the global BIN_DIR (set in setup_environment)
        echo "   - FrankenPHP not found in PATH. Using default bin directory: $BIN_DIR"
        target_bin_dir="$BIN_DIR"
    fi

    echo "   - Downloading the latest FrankenPHP binary..."
    if curl -sL https://frankenphp.dev/install.sh | $SUDO_CMD bash; then
        if [ -f "./frankenphp" ]; then
            echo "   - Moving 'frankenphp' to $target_bin_dir/..."
            if $SUDO_CMD mv ./frankenphp "$target_bin_dir/frankenphp"; then
                echo "   - ‚úÖ FrankenPHP reinstalled successfully."
            else
                gum style --foreground red "‚ùå Failed to move frankenphp." \
                    "Please run this command manually from the directory you ran the installer:" \
                    "sudo mv ./frankenphp \"$target_bin_dir/frankenphp\""
                return 1
            fi
        else
            gum style --foreground red "‚ùå FrankenPHP download script failed to create the 'frankenphp' file."
            return 1
        fi
    else
        gum style --foreground red "‚ùå The FrankenPHP download script failed."
        return 1
    fi
    return 0
}

cove_upgrade() {
    echo "üîé Checking for the latest version of Cove..."

    local download_url="https://github.com/anchorhost/cove/releases/latest/download/cove.sh"
    local temp_script="/tmp/cove.sh.latest"
    local install_path

    # Find the real path of the currently running script
    install_path=$(command -v cove)
    if [ -z "$install_path" ]; then
        install_path="/usr/local/bin/cove" # Fallback to default
    fi

    # 1. Download the latest script
    echo "   - Downloading latest Cove script from GitHub..."
    if ! curl -L --fail --progress-bar "$download_url" -o "$temp_script"; then
        echo "‚ùå Error: Failed to download the latest version. Please check your connection."
        rm -f "$temp_script" 2>/dev/null
        return 1
    fi

    # 2. Make it executable
    chmod +x "$temp_script"

    # 3. Get the new version from the downloaded script
    local new_version
    new_version=$("$temp_script" version | awk '{print $3}')

    if [ -z "$new_version" ]; then
        echo "‚ùå Error: Could not determine the version from the downloaded script."
        rm -f "$temp_script" 2>/dev/null
        return 1
    fi

    # 4. Get the current version from the running script
    local current_version="$COVE_VERSION"
    echo "   - Current Cove version:         $current_version"
    echo "   - Latest available Cove version: $new_version"

    # 5. Compare versions
    local latest
    latest=$(printf '%s\n' "$current_version" "$new_version" | sort -V | tail -n1)

    if [[ "$latest" == "$current_version" ]] && [[ "$new_version" != "$current_version" ]]; then
         echo "‚úÖ Your current Cove version ($current_version) is newer than the latest release ($new_version). No action taken."
         rm -f "$temp_script" 2>/dev/null
    elif [[ "$latest" == "$current_version" ]]; then
        echo "‚úÖ You are already using the latest version of Cove."
        rm -f "$temp_script" 2>/dev/null
    else
        # 6. Perform the Cove upgrade
        echo "üöÄ Upgrading Cove to version $new_version..."

        if [ ! -w "$(dirname "$install_path")" ]; then
            echo "‚ùå Error: No write permissions for '$(dirname "$install_path")'."
            echo "   Please try running with sudo: 'sudo cove upgrade'"
            rm -f "$temp_script" 2>/dev/null
            return 1
        fi

        if ! mv "$temp_script" "$install_path"; then
            echo "‚ùå Error: Failed to replace the old script at '$install_path'."
            rm -f "$temp_script" 2>/dev/null
        else
            echo "‚úÖ Cove has been successfully upgraded to version $new_version!"
            echo "   Run 'cove version' to see the new version."
        fi
    fi

    # --- New Section: FrankenPHP Upgrade Check ---
    echo ""
    echo "üîé Checking for FrankenPHP updates..."

    if ! command -v frankenphp &> /dev/null; then
        echo "   - ‚ö†Ô∏è FrankenPHP not found. Skipping update check."
        return 0
    fi

    # Get local version
    local local_frankenphp_version
    local_frankenphp_version=$(frankenphp version | awk '{print $2}')
    if [ -z "$local_frankenphp_version" ]; then
        echo "   - ‚ùå Could not determine local FrankenPHP version. Skipping update check."
        return 1
    fi

    # Get latest version from GitHub redirect
    local latest_frankenphp_version
    latest_frankenphp_version=$(curl -sL -o /dev/null -w '%{url_effective}' https://github.com/php/frankenphp/releases/latest | sed 's/.*\/v//')

    if [ -z "$latest_frankenphp_version" ]; then
        echo "   - ‚ùå Could not determine the latest FrankenPHP version from GitHub. Skipping update check."
        return 1
    fi

    echo "   - Current FrankenPHP version:  $local_frankenphp_version"
    echo "   - Latest available version:    $latest_frankenphp_version"

    # Use PHP for robust version comparison
    local needs_upgrade
    needs_upgrade=$(LOCAL_V="$local_frankenphp_version" REMOTE_V="$latest_frankenphp_version" php -r '
        if (version_compare(getenv("LOCAL_V"), getenv("REMOTE_V"), "<")) {
            echo "true";
        } else {
            echo "false";
        }
    ')

    if [ "$needs_upgrade" == "true" ]; then
        echo "üöÄ Upgrading FrankenPHP to version $latest_frankenphp_version..."
        upgrade_frankenphp_binary
    else
        echo "‚úÖ FrankenPHP is already up to date."
    fi
    
    # --- Adminer Upgrade Check ---
    echo ""
    echo "üîé Checking for Adminer updates..."
    
    local adminer_file="$ADMINER_DIR/adminer-core.php"
    if [ ! -f "$adminer_file" ]; then
        echo "   - ‚ö†Ô∏è Adminer not found. Skipping update check."
        return 0
    fi
    
    # Get current Adminer version from the file
    local current_adminer_version
    current_adminer_version=$(grep -oP "version\s*=\s*['\"]?\K[0-9]+\.[0-9]+\.[0-9]+" "$adminer_file" 2>/dev/null | head -1)
    if [ -z "$current_adminer_version" ]; then
        # Try alternative pattern
        current_adminer_version=$(grep -oP "Adminer\s+\K[0-9]+\.[0-9]+\.[0-9]+" "$adminer_file" 2>/dev/null | head -1)
    fi
    
    if [ -z "$current_adminer_version" ]; then
        echo "   - ‚ö†Ô∏è Could not determine current Adminer version."
        current_adminer_version="unknown"
    fi
    
    # Get latest version from GitHub
    local latest_adminer_version
    latest_adminer_version=$(curl -sL -o /dev/null -w '%{url_effective}' https://github.com/vrana/adminer/releases/latest | sed 's/.*\/v//')
    
    if [ -z "$latest_adminer_version" ]; then
        echo "   - ‚ùå Could not determine the latest Adminer version from GitHub."
        return 0
    fi
    
    echo "   - Current Adminer version:  $current_adminer_version"
    echo "   - Latest available version: $latest_adminer_version"
    
    # Compare versions (skip if current is unknown)
    if [ "$current_adminer_version" != "unknown" ]; then
        local adminer_needs_upgrade
        adminer_needs_upgrade=$(LOCAL_V="$current_adminer_version" REMOTE_V="$latest_adminer_version" php -r '
            if (version_compare(getenv("LOCAL_V"), getenv("REMOTE_V"), "<")) {
                echo "true";
            } else {
                echo "false";
            }
        ')
        
        if [ "$adminer_needs_upgrade" == "true" ]; then
            echo "üöÄ Upgrading Adminer to version $latest_adminer_version..."
            if curl -sL "https://github.com/vrana/adminer/releases/download/v${latest_adminer_version}/adminer-${latest_adminer_version}.php" -o "$adminer_file"; then
                echo "‚úÖ Adminer upgraded successfully."
            else
                echo "‚ùå Failed to download Adminer $latest_adminer_version."
            fi
        else
            echo "‚úÖ Adminer is already up to date."
        fi
    else
        # If version unknown, offer to upgrade anyway
        if gum confirm "Current version unknown. Would you like to download the latest Adminer ($latest_adminer_version)?"; then
            echo "üöÄ Downloading Adminer $latest_adminer_version..."
            if curl -sL "https://github.com/vrana/adminer/releases/download/v${latest_adminer_version}/adminer-${latest_adminer_version}.php" -o "$adminer_file"; then
                echo "‚úÖ Adminer downloaded successfully."
            else
                echo "‚ùå Failed to download Adminer $latest_adminer_version."
            fi
        fi
    fi
}